---
title: "Headspace sample processing Part 2"
output: 
  html_document:
    toc: yes
    toc_float:
      collapsed: false
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(readr)
library(dplyr)
library(RPostgreSQL)
library(uuid)
library(tidyr)
library(lubridate)
library(magrittr)
```

```{r connect, include=FALSE, message=FALSE}
password <- scan(".pgpass", what="")
db <- dbConnect(PostgreSQL(), 
                host = "sesync-postgis01.research.sesync.org",
                dbname = "choptank", 
                user = "palmergroup",
                password = password)
```

## Description

Calculate dissolved gas concentrations for headspace samples from PPM data. Then insert dissolved gas concentration data into database.

## Data

* Get PPM data from database for source air and samples
* ppmv data for source gas - determined from GC workflow
* ppmv data for sample gas - determined from GC workflow
* water temperature - measured in the field or offset from GSODR
* barometric pressure - measured in the field or from GSODR data
* source gas sample volume - default 20 mL
* sample gas sample volume - default 40 mL

**PPM data**

Reshape the data so there is one row for each headspace sample with the required inputs for the `def.calc.sdg()` function. 

```{r, include=FALSE}
source('R/db_get_hs_sources.R')
```

```{r}
hs_sources <- db_get_hs_sources() 
hs_sources %>% kable()
```

Get the methane and co2 ppm data for each sample 

```{r}
db_get_gc_data <- function(){
sql <- "SELECT sf.samplingfeaturecode, v.variablecode, u.unitsname, mrv.datavalue, mrv.valuedatetime  
  FROM odm2.measurementresultvalues mrv, odm2.results r, odm2.variables v, odm2.units u, odm2.samplingfeatures sf, odm2.featureactions fa, odm2.methods m, odm2.actions act
 WHERE r.variableid = v.variableid
 AND fa.actionid = act.actionid
 AND act.methodid = m.methodid
 AND r.featureactionid = fa.featureactionid
 AND fa.samplingfeatureid = sf.samplingfeatureid
 AND r.unitsid = u.unitsid
 AND mrv.resultid = r.resultid 
 AND r.sampledmediumcv = 'gas'
 AND m.methodcode = 'GC'"

sql <- gsub("\n", "", sql)
dbGetQuery(db, sql)
}
```
```{r}
ppms <- db_get_gc_data()
ppms %>% kable()
```

Now we have hs sources and the ppm data. Join in wide format for the sdg function

```{r}
sdg_data <- hs_sources %>% 
  left_join(ppms, by = c("source" = "samplingfeaturecode")) %>%
  dplyr::select(-unitsname, -valuedatetime) %>%
  filter(variablecode %in% c("carbonDioxide", "methane")) %>%
  spread(key = variablecode, value = datavalue) %>%
  rename(concentrationCO2Air = carbonDioxide, concentrationCH4Air = methane) %>%
  left_join(ppms, by = c("hs" = "samplingfeaturecode")) %>%
  dplyr::select(-unitsname) %>%
  filter(variablecode %in% c("carbonDioxide", "methane")) %>%
  spread(key = variablecode, value = datavalue) %>%
  rename(concentrationCO2Gas = carbonDioxide, concentrationCH4Gas = methane)
```

get table of where each sample was collected 

```{r, warning=FALSE}
sql <- "SELECT * FROM odm2.relatedfeatures WHERE relationshiptypecv = 'wasCollectedAt'"
sql <- gsub("\n", "", sql)
rf <- dbGetQuery(db, sql)
sampfeatures <- dbReadTable(db, c("odm2", "samplingfeatures"))
samps_join_sites <- rf %>% 
  left_join(sampfeatures, by = c("samplingfeatureid" = "samplingfeatureid")) %>%
  dplyr::select(relationid, samplingfeaturecode, relationshiptypecv, relatedfeatureid) %>%
  rename(specimencode = samplingfeaturecode) %>%
  left_join(sampfeatures, by = c("relatedfeatureid" = "samplingfeatureid")) %>%
  dplyr::select(specimencode, relationshiptypecv, samplingfeaturecode)
kable(samps_join_sites)
```

add sites to sdg data

```{r}
sdg_data %<>% left_join(samps_join_sites, by = c("hs" = "specimencode")) %>%
  dplyr::select(- relationshiptypecv) %>% rename(site = samplingfeaturecode)
```

**Water Temp**

add in water temp data from field data collection. 

**Barometric pressure**

Add column for barometric pressure and temp on day of sampling from Dover AFB GSOD data. 

```{r, message=FALSE}
gsod <- read_csv("data/gsod_data.csv")
```

convert gsod data from mb to kPa

```{r}
gsod$STP_kPa <- gsod$STP*0.1
gsod$TEMP_C <- gsod$TEMP
```


relevant columns in gsod data are YEARMODA, STP_kPa, TEMP. TEMP is mean daily temperature in Celcius (GSOD package does conversion to SI units).

```{r}
sdg_data$date <- date(sdg_data$valuedatetime)
gsod %<>% dplyr::select(YEARMODA, STP_kPa, TEMP_C)
sdg_data %<>% left_join(gsod, by = c("date" = "YEARMODA"))
```

```{r}
sdg_data$concentrationN2OAir = NA
sdg_data$concentrationN2OGas = NA
sdg_data %<>% mutate(headspaceTemp = TEMP_C) %>% 
  rename(barometricPressure = STP_kPa, waterTemp = TEMP_C) %>%
  mutate(gasVolume = 20, waterVolume = 40)
```

# Calculations

Calculations are based on the NEON dissolved gas function. Add proper citation to [here](https://github.com/NEONScience/NEON-dissolved-gas). 

```{r}
source('def.calc.sdg.R')
```

Use function by supplying column names and defaults. Output is concentrations and 100% saturation concentrations as additional columns on the data frame. 

```{r, eval=FALSE}
sdg_out <- def.calc.sdg(inputFile = sdg_data)
```

output is in [M]

```{r}
sdg_results <- sdg_out %>%
  mutate(dissolvedCH4_umol = dissolvedCH4 * 1e6,
         dissolvedCO2_umol = dissolvedCO2 * 1e6,
         satCH4_umol = satCH4 * 1e6) %>%
  dplyr::select(hs, site, date, valuedatetime, dissolvedCH4_umol, dissolvedCO2_umol, satCH4_umol)
```


Reshape concentration data to put values in database for each sample

# Insert concentration results

* add action for specimen analysis(?)
* add feature action with new sample and new action for sample analysis
* add 2 results associated with sample analysis feature action - co2 umol per L and ch4 umol per L
* variable = methaneDissolved, carbonDioxideDissolved
* units = umol per L
* add measurement results 
* add measurement result values

add relationship between results to show that umol per L data are derived from ppm data of 2 samples, water temp, pressure data? 

# Miscellaneous

* Compare GSODR data for barometric pressure vs. field measurements
* Compare GSODR data for air temperature to field measurements of air and water temperature
